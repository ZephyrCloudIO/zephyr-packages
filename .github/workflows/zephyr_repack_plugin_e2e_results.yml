name: Listen for Zephyr Repack Plugin E2E test completion

on:
  workflow_run:
    workflows: ["Zephyr Repack Plugin E2E testing"]
    types:
      - completed

jobs:
  check-result:
    runs-on: ubuntu-latest
    steps:
      - name: Get Workflow Status
        run: |
          echo "E2E Workflow Run ID: ${{ github.event.workflow_run.id }}"
          echo "E2E Workflow Status: ${{ github.event.workflow_run.status }}"
          echo "E2E Workflow Conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "Triggered by Commit SHA: ${{ github.event.workflow_run.head_sha }}"
          echo "Run URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}"

      - name: Post Result as a GitHub Comment
        if: always()
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const runId = ${{ github.event.workflow_run.id }};
            const conclusion = "${{ github.event.workflow_run.conclusion }}";
            const commitSha = "${{ github.event.workflow_run.head_sha }}";
            const runUrl = "https://github.com/${{ github.repository }}/actions/runs/" + runId;

            let message = `### üöÄ Zephyr Repack Plugin E2E Test Results\n\n`;
            message += `- **Status:** ${conclusion.toUpperCase()}\n`;
            message += `- **Commit SHA:** \`${commitSha}\`\n`;
            message += `- [üîç View Full Logs](${runUrl})\n`;

            if (conclusion !== "success") {
              message += `\n‚ùå **E2E tests failed!** Please check the logs.`;
            } else {
              message += `\n‚úÖ **E2E tests passed successfully!**`;
            }

            // Post comment to the PR (if triggered by a PR)
            const { owner, repo } = context.repo;
            const pullRequests = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner,
              repo,
              commit_sha: commitSha
            });

            if (pullRequests.data.length > 0) {
              const prNumber = pullRequests.data[0].number;
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: message
              });
            } else {
              console.log("No associated PR found for this commit.");
            }

      - name: Fail if Tests Failed
        if: github.event.workflow_run.conclusion != 'success'
        run: |
          echo "‚ùå E2E tests failed! See logs above."
          exit 1
